<!doctype html><html lang=en-us data-theme><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>mock-inspect: A simple way to achieve contract testing - rickschubert.net blog</title><meta name=description content><link rel=icon type=image/x-icon href=https://rickschubert.net/blog/favicon.ico><link rel=apple-touch-icon-precomposed href=https://rickschubert.net/blog/favicon.png><link rel=stylesheet href=https://rickschubert.net/blog/css/style.min.ada65744b50c0c8e95fce70ffd6071f0d8830f31d28d4629c2a760b4cd8f97d1.css integrity><meta property="og:title" content="mock-inspect: A simple way to achieve contract testing"><meta property="og:description" content="This article is part of a series about the open-source Node.js testing library _mock-inspect_ of which I am the main contributor and author. Check out the entire series here! In last week&rsquo;s article, we discussed how we can use mock-inspect to assert if and how the application under test makes network requests to API endpoints while simultaneously mocking out their responses. This week we are going to explore how we can use mock-inspect to implement a contract testing strategy without complicated frameworks like PACT."><meta property="og:type" content="article"><meta property="og:url" content="https://rickschubert.net/blog/posts/mock-inspect-contract-testing/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-27T23:23:02+01:00"><meta property="article:modified_time" content="2021-05-27T23:23:02+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="mock-inspect: A simple way to achieve contract testing"><meta name=twitter:description content="This article is part of a series about the open-source Node.js testing library _mock-inspect_ of which I am the main contributor and author. Check out the entire series here! In last week&rsquo;s article, we discussed how we can use mock-inspect to assert if and how the application under test makes network requests to API endpoints while simultaneously mocking out their responses. This week we are going to explore how we can use mock-inspect to implement a contract testing strategy without complicated frameworks like PACT."><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-252785X60E","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header class=common-header><div class=site-header><a class=site-title href=https://rickschubert.net/blog/>rickschubert.net blog</a>
<button class=theme-switcher></button>
<script>const moonSVG=`<svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path></svg>`,sunSVG=`<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,STORAGE_KEY="user-color-scheme",defaultTheme="auto";let currentTheme,switchButton,autoDefinedScheme=window.matchMedia("(prefers-color-scheme: dark)");const autoChangeScheme=e=>{currentTheme=e.matches?"dark":"light",document.documentElement.setAttribute("data-theme",currentTheme),changeButtonText()};document.addEventListener("DOMContentLoaded",function(){switchButton=document.querySelector(".theme-switcher"),currentTheme=detectCurrentScheme(),currentTheme=="dark"&&document.documentElement.setAttribute("data-theme","dark"),currentTheme=="auto"&&(autoChangeScheme(autoDefinedScheme),autoDefinedScheme.addListener(autoChangeScheme)),changeButtonText(),switchButton.addEventListener("click",switchTheme,!1)});function detectCurrentScheme(){return localStorage.getItem(STORAGE_KEY)?localStorage.getItem(STORAGE_KEY):defaultTheme?defaultTheme:window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":"light"}function changeButtonText(){switchButton.innerHTML=currentTheme=="dark"?moonSVG:sunSVG}function switchTheme(){currentTheme=="dark"?(localStorage.setItem(STORAGE_KEY,"light"),document.documentElement.setAttribute("data-theme","light"),currentTheme="light"):(localStorage.setItem(STORAGE_KEY,"dark"),document.documentElement.setAttribute("data-theme","dark"),currentTheme="dark"),changeButtonText()}</script></div></header><main id=main tabindex=-1><article class=post><header class=post-header><h1 class=post-title>mock-inspect: A simple way to achieve contract testing</h1></header><div class=content><div class=post-heroimage><img src=https://rickschubert.net/blog/images/mock-inspect-chameleon.png></div><div class=callout>This article is part of a series about the open-source Node.js testing library _mock-inspect_ of which I am the main contributor and author. <a href=https://rickschubert.net/blog/tags/mock-inspect>Check out the entire series here!</a></div><p>In <a href=https://rickschubert.net/blog/posts/mock-inspect-what-it-is-and-how-to-use-it>last week&rsquo;s article</a>, we discussed how we can use <a href=https://github.com/trayio/mock-inspect><em>mock-inspect</em></a> to assert <em>if</em> and <em>how</em> the application under test makes network requests to API endpoints while simultaneously mocking out their responses. This week we are going to explore how we can use <em>mock-inspect</em> to implement a contract testing strategy without complicated frameworks like PACT.</p><p>This post is accompanied by a <a href=https://github.com/rickschubert/mock-inspect-contract-testing-example>GitHub repository</a> which holds all the code examples so that they can be tried out locally.</p><h2 id=understanding-contract-testing>Understanding contract testing</h2><p>A network request is made out of two steps:</p><ul><li>The <strong>consumer</strong> <em>asks</em> for something</li><li>The <strong>provider</strong> <em>answers</em> with something</li></ul><p>The problem is usually that provider and consumer sit in different code bases. Think of a web app: The provider would be the backend server and the consumer would be a frontend application questioning the backend server. Both projects usually live in separate repositories.</p><p>Contract testing aims to ensure that if the consumer <em>asks</em> for the right thing, the provider <em>answers</em> with the right thing. A popular testing framework for this is <a href=https://docs.pact.io/>PACT</a> which is a monster on its own, providing beefy implementations for a multitude of programming languages. The way it works is by setting up a &ldquo;contract&rdquo; which contains information about how the request should be made and what the API should respond with. To check the consumer side, PACT would tell you to create a mock server that responds with some mocked data given that the request has been made the right way.</p><p><em>mock-inspect</em> is a Node.js tool which allows you to mock network requests and inspect how these requests were made. You can see where I am going with this: As long as the consumer is written in Node.js (like a frontend application or a backend server), we can use <em>mock-inspect</em> for contract testing - no need for the complicated PACT framework.</p><h2 id=strategy-overview-no-contracts-yet>Strategy overview (no contracts yet)</h2><p>In contract testing, we want to test both aspects of the flow: the provider and the consumer side.</p><p>A provider test is simple to do and doesn&rsquo;t even need <em>mock-inspect</em>. As long as we write a test for our backend server which asserts that the response is correct (given the correct request was made), we have already the provider side covered. Pretty easy.</p><p>More interesting is the consumer side which is where <em>mock-inspect</em> can be used. No matter if your consumer is a backend server or a frontend application, as long as it is written in Node.js and making a network request, <em>mock-inspect</em> can help you. All we have to do is to write a test with a mocked network request and then assert that the consumer has asked the right question, i.e. has included the correct headers and payload. This is how such a consumer test could look like in mock-inspect:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>mockRequest</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;mock-inspect&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Inside your test
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Step 1: Set up the mock for the third party API so that your test
</span></span></span><span style=display:flex><span><span style=color:#75715e>// does not hit the real API. Provide a fixed response body.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>thirdPartyMock</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>mockRequest</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;http://localhost:5000/v1/cities_you_can_fly_to&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;POST&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>responseBody</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>London</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Birmingham</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Edinburgh</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#75715e>// Step 2: Have your test execute the code which is expected
</span></span></span><span style=display:flex><span><span style=color:#75715e>// to call the provider (backend server)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>printPossibleLocations</span>()
</span></span><span style=display:flex><span><span style=color:#75715e>// Step 3: Using mock-inspect&#39;s `inspect()` method available on
</span></span></span><span style=display:flex><span><span style=color:#75715e>// instances returned by `mockRequest`, check out how the request
</span></span></span><span style=display:flex><span><span style=color:#75715e>// was made and match it against your expectations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>requestPayload</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>requestHeaders</span>
</span></span><span style=display:flex><span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>thirdPartyMock</span>.<span style=color:#a6e22e>inspect</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>requestHeaders</span>[<span style=color:#e6db74>&#34;authorization&#34;</span>]).<span style=color:#a6e22e>toEqual</span>(<span style=color:#e6db74>&#34;Bearer my_API_token_was_used&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>requestPayload</span>).<span style=color:#a6e22e>toEqual</span>({<span style=color:#a6e22e>filterByCountry</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;England&#34;</span>})
</span></span></code></pre></div><p>The above test executes our function which is making a network request to our backend server (the &ldquo;provider&rdquo;) and then asserts that the request has been made correctly. In the example above, we are checking that the API token has been forwarded in the request headers and that a request payload has been used to filter the list of cities by a specific country.</p><h2 id=adding-a-contract>Adding a contract</h2><p>We now have two separate test suites which do their job. But the problem is that these tests don&rsquo;t yet relate to each other: we could end up modifying the expectations on one side only to realise that these don&rsquo;t match up anymore with the behaviour on the other side.</p><p>This is where contracts come in. A contract is a way of codifying the behaviour for both sides of the request, consumer and provider. The provider (the backend server) agrees to respond with a certain message as long as it is asked the correct question. The consumer in turn can be sure that it will receive the correct answer given it asks the right question.</p><p>A suitable format for this information is JSON as it can be understood by any programming language. That way, we can use contract testing even for non-Node.js providers, no matter if these are written in Java, Golang or something else. I would structure a contract as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;request&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;http://localhost:5000/v1/cities_you_can_fly_to&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;method&#34;</span>: <span style=color:#e6db74>&#34;POST&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;payload&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;filterByCountry&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;string&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;minLength&#34;</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;additionalProperties&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;required&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;filterByCountry&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;headers&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;authorization&#34;</span>: <span style=color:#e6db74>&#34;Bearer my_API_token_was_used&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;response&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;body&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;minProperties&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;patternProperties&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;^.*$&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;boolean&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;statusCode&#34;</span>: <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;headers&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;content-type&#34;</span>: <span style=color:#e6db74>&#34;application/json; charset=utf-8&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We are defining two pieces of information here:</p><ul><li>In <code>request</code>, we define <strong>how the request should be made</strong>. We should be hitting the desired URL with the <code>POST</code> method and we need to provide a JSON payload. The JSON payload needs to follow a specific <a href=https://json-schema.org/>JSON schema</a>. To explain JSON schema would be out of scope for this article but in short, it is a way of describing JSON structures. In the case above, we say that the <code>payload</code> needs to be a JSON object with a required property called <code>filterByCountry</code> which holds a string value.</li><li>In <code>response</code>, we define <strong>what the API should return</strong>. The API should respond with a status code of 200 and the <code>application/json; charset=utf-8</code> header as Content-Type. The response body should be a JSON object with at least three properties which should all hold a boolean value.</li></ul><p>These contracts are best placed into a separate repository so that they can be accessed by different test suites. Ideally, you would version this repository either using NPM modules or with git tags. Versioning allows for different test suites to use these contracts independently and makes updating test suites a breeze.</p><p>Once we have the contract finished, all we have to do is set up our two tests so that they make use of the contract instead of the previously hard-coded values. The provider test (for the backend server) will now take the JSON schema defined under <code>response.body</code> and assert that the API does indeed serve a JSON structure matching that schema. The test will now also check that the status code and the headers match those defined in <code>response</code>.</p><p>Below is how the provider test looks with contracts. We are using the NPM library <a href=https://json-schema-faker.js.org/><code>json-schema-faker</code></a> to generate a sample request payload that abides by the rules stated in the contract&rsquo;s JSON schema. Additionally, we are using the <a href=https://github.com/ajv-validator/ajv>AJV library</a> to assert that the response body matches the JSON schema.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>request</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;request-promise&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>contract</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../../contracts/v1/cities_you_can_fly_to.json&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// Used to auto-generate a request payload from the contract&#39;s JSON schema
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jsonSchemaFaker</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;json-schema-faker&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// Used to validate that the response body matches the JSON schema
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>AJV</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;ajv&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ajv</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AJV</span>({<span style=color:#a6e22e>allErrors</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>request</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>url</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>method</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>headers</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>jsonSchemaFaker</span>.<span style=color:#a6e22e>generate</span>(<span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>payload</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resolveWithFullResponse</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>statusCode</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusCode</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>header</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>headers</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#a6e22e>header</span>]).<span style=color:#a6e22e>toBe</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#a6e22e>header</span>],
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validator</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ajv</span>.<span style=color:#a6e22e>compile</span>(<span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>body</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isValid</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>validator</span>(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>body</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>isValid</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Our provider did not send a response body matching&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;the contract response body.&#34;</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The consumer test works similarly, but this time we are generating a sample response and validate against the request payload. Thanks to <em>mock-inspect</em>, we don&rsquo;t need to run the backend server for our unit tests: <em>mock-inspect</em> mocks the outgoing network request and returns the specified sample response. We can make use of the <code>inspect()</code> method exposed by <em>mock-inspect</em> to see how a request has been made. This is exactly what we want to assert on the consumer side: we want to ensure that the consumer makes the network request as stated in the contract.</p><p>This is how our consumer test looks like after introducing contracts:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>printPossibleLocations</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../index.js&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>contract</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../../contracts/v1/cities_you_can_fly_to.json&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// Used to mock the network request going to the API
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>mockRequest</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;mock-inspect&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// Used to auto-generate a response from the contract&#39;s JSON schema
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jsonSchemaFaker</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;json-schema-faker&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// Used to validate that the request payload matches the JSON schema
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>AJV</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;ajv&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ajv</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AJV</span>({<span style=color:#a6e22e>allErrors</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>citiesRequest</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>mockRequest</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>requestPattern</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>url</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>requestMethod</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>method</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>responseBody</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>jsonSchemaFaker</span>.<span style=color:#a6e22e>generate</span>(<span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>body</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>responseStatus</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusCode</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>responseHeaders</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>headers</span>,
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>printPossibleLocations</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>requestBody</span>, <span style=color:#a6e22e>requestHeaders</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>citiesRequest</span>.<span style=color:#a6e22e>inspect</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>header</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>headers</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>requestHeaders</span>[<span style=color:#a6e22e>header</span>]).<span style=color:#a6e22e>toBe</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#a6e22e>header</span>],
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validator</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ajv</span>.<span style=color:#a6e22e>compile</span>(<span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>payload</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isValid</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>validator</span>(<span style=color:#a6e22e>requestBody</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>isValid</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Our consumer did not send a request payload matching&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;the contract request payload.&#34;</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=closing-words>Closing words</h2><p>As you saw, it is easy to do contract testing with <em>mock-inspect</em>, there is no need for complicated frameworks like PACT. All we need is a consumer written in Node.js so that we can use <em>mock-inspect</em> to mock network requests. Since any programming language can read JSON files, providers can make use of the contracts in their test suites, no matter if these provider services are written in Java, Golang or any other language - the same principles apply.</p><p>I wish you a lot of fun with contract testing! Should you have any questions, don&rsquo;t hesitate to reach out to us over at <a href=https://github.com/trayio/mock-inspect><em>mock-inspect</em></a>.</p><hr><p><a href=https://github.com/trayio/mock-inspect/tree/main/assets/chameleon.png>Chameleon</a> graphic by <a href="https://pixabay.com/users/monstreh-637659/?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=3340930">Анна Куликова</a> from <a href="https://pixabay.com/?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=3340930">Pixabay</a></p></div><div class=post-info><div class=post-date>27 May 2021</div><div class=post-taxonomies><ul class=post-tags><li><a href=https://rickschubert.net/blog/tags/programming>#programming</a></li><li><a href=https://rickschubert.net/blog/tags/mock-inspect>#mock-inspect</a></li></ul></div></div></article><div class="pagination post-pagination"><div class="left pagination-item"><a href=https://rickschubert.net/blog/posts/how-i-wrote-an-application-to-help-me-write-a-screenplay/>How I wrote an application to help me write a screenplay</a></div><div class="right pagination-item"><a href=https://rickschubert.net/blog/posts/mock-inspect-what-it-is-and-how-to-use-it/>mock-inspect: Mock network requests and observe how these requests were made</a></div></div></main><footer class=common-footer><a class=rss href=https://rickschubert.net/blog/index.xml><img src=https://rickschubert.net/blog/images/rss.svg> Subscribe to RSS feed</a><nav><a href=https://rickschubert.net/blog/posts/ title=Archive>Archive</a></nav><div class=common-footer-bottom><div class=copyright><p>© Rick Schubert, 2022<br></p></div></div></footer></div></body></html>